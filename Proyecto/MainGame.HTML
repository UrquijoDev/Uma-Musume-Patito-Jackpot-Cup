<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salva a Mambo - Tracen Arcade</title>
    <style>
        :root {
            --green-primary: #4ade80;
            --green-dark: #16a34a;
            --pink-primary: #ec4899;
            --pink-dark: #be185d;
            --blue-primary: #60a5fa;
            --yellow-primary: #facc15;
            --slate-900: #0f172a;
            --slate-800: #1e293b;
            --slate-600: #475569;
            --white: #ffffff;
            --font-main: system-ui, -apple-system, sans-serif;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-main);
            background-color: #f0fdf4;
            color: var(--slate-800);
            min-height: 100vh;
            overflow-x: hidden;
            /* Fondo personalizado */
            background-image: url('assets/img/Fondo.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }

        /* --- UTILS --- */
        .hidden {
            display: none !important;
        }

        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .items-center {
            align-items: center;
        }

        .justify-center {
            justify-content: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-2 {
            gap: 0.5rem;
        }

        .p-4 {
            padding: 1rem;
        }

        .btn {
            cursor: pointer;
            border: none;
            font-weight: bold;
            transition: transform 0.1s;
            border-radius: 0.5rem;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* --- HEADER & PROGRESS --- */
        header {
            position: sticky;
            top: 0;
            z-index: 50;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(4px);
            padding: 0.5rem 1rem;
            border-bottom: 4px solid var(--pink-primary);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .brand {
            font-size: 1.1rem;
            font-style: italic;
            color: var(--pink-dark);
            text-transform: uppercase;
            font-weight: 900;
        }

        .wallet {
            background: #fef9c3;
            color: #b45309;
            border: 2px solid #facc15;
            padding: 0.25rem 0.8rem;
            border-radius: 9999px;
            font-family: monospace;
            font-size: 1rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-container {
            width: 100%;
            background: #e2e8f0;
            height: 20px;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            border: 1px solid #cbd5e1;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--pink-primary), var(--pink-dark));
            width: 0%;
            transition: width 0.5s ease-out;
        }

        .progress-text {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: #fff;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* --- MENU (GRID 3x3 + TIENDA) --- */
        .menu-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            /* 3 Columnas */
            grid-template-rows: 1fr 1fr 1fr auto;
            /* 3 Filas para juegos + 1 para tienda */
            gap: 1.5rem;
            padding: 2rem;
            max-width: 1000px;
            margin: 0 auto;
            min-height: 70vh;
            /* Altura m√≠nima para que se vea bien la distribuci√≥n */

            /* Definici√≥n de √Åreas del Grid */
            grid-template-areas:
                "roulette . flip"
                "roulette memory flip"
                "roulette . flip"
                "shop shop shop";
        }

        /* Estilos de las Tarjetas del Men√∫ */
        .menu-card {
            background: white;
            border-radius: 1rem;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .menu-card:hover {
            transform: translateY(-5px) scale(1.02);
            border-color: var(--pink-primary);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
        }

        .menu-card h3 {
            margin: 0.5rem 0;
            font-size: 1.2rem;
            color: var(--slate-800);
            font-weight: 800;
            text-transform: uppercase;
            font-style: italic;
        }

        /* Asignaci√≥n de √Åreas Espec√≠ficas */
        .area-roulette {
            grid-area: roulette;
            background: linear-gradient(to bottom right, #fff, #f0fdf4);
            border-left: 5px solid var(--green-dark);
        }

        .area-memory {
            grid-area: memory;
            background: linear-gradient(to bottom right, #fff, #eff6ff);
            border-top: 5px solid var(--blue-primary);
        }

        .area-flip {
            grid-area: flip;
            background: linear-gradient(to bottom right, #fff, #fff7ed);
            border-right: 5px solid #f97316;
        }

        .area-shop {
            grid-area: shop;
            background: linear-gradient(to right, #fff1f2, #ffe4e6);
            border-color: #fda4af;
            border-bottom: 5px solid var(--pink-dark);
            flex-direction: row;
            gap: 2rem;
        }

        /* Media Query para M√≥viles (se apilan verticalmente si la pantalla es muy chica) */
        @media (max-width: 768px) {
            .menu-grid {
                grid-template-columns: 1fr;
                grid-template-rows: auto;
                grid-template-areas:
                    "roulette"
                    "memory"
                    "flip"
                    "shop";
            }

            .area-shop {
                flex-direction: column;
                gap: 0.5rem;
            }
        }

        /* --- DIFFICULTY SELECTOR --- */
        .diff-modal {
            background: white;
            padding: 1.5rem;
            border-radius: 1.5rem;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            border: 4px solid var(--blue-primary);
            text-align: center;
            margin: 2rem auto;
            animation: popIn 0.3s;
        }

        .bet-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .bet-option {
            background: #f1f5f9;
            border: 2px solid #cbd5e1;
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--slate-600);
            cursor: pointer;
        }

        .bet-option.selected {
            background: var(--blue-primary);
            color: white;
            border-color: #2563eb;
        }

        /* --- SHOP --- */
        .shop-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 1rem;
            background: #fff1f2;
            min-height: 80vh;
        }

        .shop-header-img {

            display: block;
            margin: 0 auto 1rem;
            width: 350px;
            max-width: 100%;
            height: auto;
            background: #ddd;
            border-radius: 1rem;
            margin-bottom: 1rem;
            object-fit: contain;
            border: 4px solid white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
            font-weight: bold;
        }

        .shop-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .item-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: white;
            padding: 1rem;
            border-radius: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-left: 5px solid var(--slate-600);
        }

        .item-row.buff {
            border-left-color: var(--blue-primary);
        }

        .item-row.win {
            border-left-color: var(--yellow-primary);
            background: #fffbeb;
        }

        .buy-btn {
            margin-left: auto;
            background: var(--green-dark);
            color: white;
            padding: 0.5rem 1rem;
        }

        /* --- MAMBO CORNER (Asistente) --- */
        #host-corner {
            position: fixed;
            bottom: 0;
            left: 1rem;
            z-index: 40;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            pointer-events: none;
            /* Allows clicking through empty space */
        }

        .host-bubble {
            background: white;
            padding: 0.75rem 1rem;
            border-radius: 1rem 1rem 1rem 0;
            border: 2px solid var(--pink-light);
            font-size: 0.85rem;
            font-weight: bold;
            color: var(--slate-600);
            margin-bottom: 0.5rem;
            margin-left: 3rem;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            pointer-events: auto;
        }

        .host-img-small {
            width: 100px;
            height: 140px;
            object-fit: cover;
            object-position: top;
            mask-image: linear-gradient(to bottom, black 70%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 70%, transparent 100%);
            cursor: pointer;
            transition: transform 0.2s;
            pointer-events: auto;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5));
        }

        .host-img-small:hover {
            transform: scale(1.05);
        }

        .host-img-small:hover+.host-bubble,
        .host-bubble.show {
            opacity: 1;
            transform: translateY(0);
        }


        /* --- NARRATIVE OVERLAY --- */
        #story-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }

        #story-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .story-box {
            width: 100%;
            max-width: 600px;
            padding: 1rem;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .character-sprite {
            width: 200px;
            height: 300px;
            object-fit: contain;
            object-position: bottom;
            filter: drop-shadow(0 0 10px rgba(236, 72, 153, 0.5));
            transition: all 0.3s;
            margin-bottom: -20px;
            z-index: 10;
        }

        /* Emociones */
        .sprite-normal {
            filter: brightness(1);
        }

        .sprite-sad {
            filter: grayscale(0.2) brightness(0.9);
            transform: translateY(5px);
        }

        .sprite-happy {
            filter: brightness(1.1) drop-shadow(0 0 15px gold);
            transform: scale(1.05);
        }

        .sprite-shock {
            animation: shake 0.5s;
            filter: contrast(1.2);
        }

        .dialogue-box {
            background: rgba(255, 255, 255, 0.95);
            width: 100%;
            padding: 1.5rem;
            padding-top: 2rem;
            border-radius: 1rem;
            border: 4px solid var(--pink-primary);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            position: relative;
            z-index: 20;
            text-align: left;
        }

        .speaker-name {
            position: absolute;
            top: -15px;
            left: 20px;
            background: var(--pink-dark);
            color: white;
            padding: 0.25rem 1rem;
            border-radius: 1rem;
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* --- GAME BOARDS --- */
        .game-area {
            max-width: 600px;
            margin: 1rem auto;
            background: white;
            padding: 1rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Carrot Flip specific */
        .flip-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 4px;
        }

        .flip-cell {
            aspect-ratio: 1;
            background: var(--green-primary);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            position: relative;
            border-bottom: 3px solid var(--green-dark);
            font-size: 1.2rem;
        }

        .flip-cell:active {
            border-bottom: 0;
            transform: translateY(3px);
        }

        .flip-cell.flipped {
            background: white;
            border: 1px solid #ddd;
            color: var(--slate-800);
            transform: none;
            cursor: default;
        }

        .info-cell {
            background: #ffedd5;
            font-size: 0.8rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            color: #c2410c;
            font-weight: bold;
            border: 1px solid #fdba74;
        }

        .memo-marker {
            position: absolute;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.9);
            pointer-events: none;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.5);
        }

        .m-0 {
            top: 2px;
            left: 2px;
        }

        .m-1 {
            top: 2px;
            right: 2px;
        }

        .m-2 {
            bottom: 2px;
            left: 2px;
        }

        .m-3 {
            bottom: 2px;
            right: 2px;
        }

        /* Memory Match Specific */
        .memory-board {
            display: grid;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        /* Roulette Specific */
        .roulette-container {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        .roulette-girl-img {
            width: 120px;
            height: 200px;
            object-fit: cover;
            border-radius: 1rem;
            border: 4px solid var(--pink-primary);
            display: none;
        }

        /* Hidden on mobile by default or flex col */
        @media (min-width: 600px) {
            .roulette-girl-img {
                display: block;
            }
        }

        /* Animations */
        @keyframes popIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        .active-buff {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 1.5rem;
            animation: popIn 0.5s;
        }

        .result-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            border: 4px solid var(--yellow-primary);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            z-index: 200;
            text-align: center;
            animation: popIn 0.3s;
        }
    </style>
</head>

<body>

    <div id="app">
        <!-- HEADER -->
        <header>
            <div class="header-top">
                <div class="brand">MAMBO'S DEBT</div>
                <div class="wallet">ü•ï <span id="ui-carrots">100</span></div>
            </div>
            <div class="progress-container">
                <div class="progress-bar" id="ui-progress"></div>
                <div class="progress-text">LIBERTAD: <span id="ui-paid">0</span> / <span id="ui-debt">50000</span></div>
            </div>
        </header>

        <!-- MENU PRINCIPAL -->
        <div id="view-menu" class="menu-grid">
            <!-- 1. Izquierda: Derby Roulette -->
            <div class="menu-card area-roulette" onclick="game.openDifficulty('roulette')">
                <div style="font-size:3rem;">üé∞</div>
                <h3>Derby Roulette</h3>
                <p style="font-size:0.9rem; color:#64748b;">¬°Apuesta al G1!</p>
            </div>

            <!-- 2. Centro: Memory Match -->
            <div class="menu-card area-memory" onclick="game.openDifficulty('memory')">
                <div style="font-size:3rem;">üß†</div>
                <h3>Memory Match</h3>
                <p style="font-size:0.9rem; color:#64748b;">Entrena tu mente.</p>
            </div>

            <!-- 3. Derecha: Carrot Flip -->
            <div class="menu-card area-flip" onclick="game.openDifficulty('flip')">
                <div style="font-size:3rem;">üí£</div>
                <h3>Carrot Flip</h3>
                <p style="font-size:0.9rem; color:#64748b;">Alto riesgo.</p>
            </div>

            <!-- 4. Abajo: Tienda -->
            <div class="menu-card shop-card area-shop" onclick="app.showShop()">
                <div style="font-size:3rem;">üõí</div>
                <div>
                    <h3>Mercado Negro</h3>
                    <p style="font-size:0.9rem; color:#be185d;">Items, Mejoras y Pagos.</p>
                </div>
            </div>
        </div>

        <!-- SELECTOR DE DIFICULTAD/APUESTA -->
        <div id="view-difficulty" class="hidden">
            <div class="diff-modal">
                <h2 style="margin-top:0;">Elige tu Apuesta</h2>
                <p style="font-size:0.9rem; color:#64748b;">Cuanto m√°s apuestes, m√°s dif√≠cil ser√°, pero ganar√°s m√°s.</p>

                <div class="bet-grid" id="diff-options">
                    <!-- JS generar√° opciones -->
                </div>

                <p id="diff-desc" style="font-size:0.8rem; font-style:italic; height:20px; color:#be185d;"></p>

                <div class="flex justify-between" style="margin-top:1.5rem;">
                    <button class="btn" onclick="app.showMenu()"
                        style="background:#e2e8f0; color:#475569; padding:0.5rem 1rem;">Cancelar</button>
                    <button class="btn" onclick="game.confirmStart()" id="btn-start-game" disabled
                        style="background:var(--green-dark); color:white; padding:0.5rem 2rem;">¬°Jugar!</button>
                </div>
            </div>
        </div>

        <!-- TIENDA -->
        <div id="view-shop" class="hidden">
            <div class="shop-container">
                <!-- Imagen de la chica de la tienda (Placeholder) -->
                <img src="assets/img/SpecialweekSTSF.png" class="shop-header-img" alt="Due√±a de la Tienda">

                <div class="shop-grid">
                    <h2 style="text-align:center; color:var(--slate-800); margin:0;">Mercado Negro</h2>
                    <p style="text-align:center; font-size:0.8rem; color:var(--slate-600);">"Todo tiene un precio,
                        cari√±o..."</p>

                    <button class="btn" onclick="app.showMenu()"
                        style="margin: 0 auto 1rem auto; background:#e2e8f0; width: fit-content; padding: 15px 40px; display: block;">
                        Volver al Casino
                    </button>

                    <!-- Items -->
                    <div class="item-row buff">
                        <div style="font-size:2rem;">‚õëÔ∏è</div>
                        <div>
                            <strong>Casco Veloz</strong><br>
                            <span style="font-size:0.8rem; color:#64748b;">x2 Ganancias en Carrot Flip (5 usos)</span>
                        </div>
                        <button class="btn buy-btn" onclick="shop.buy('helmet', 500)">500ü•ï</button>
                    </div>

                    <div class="item-row buff">
                        <div style="font-size:2rem;">üî≠</div>
                        <div>
                            <strong>Binoculares</strong><br>
                            <span style="font-size:0.8rem; color:#64748b;">Revela 3 bombas en Carrot Flip</span>
                        </div>
                        <button class="btn buy-btn" onclick="shop.buy('glasses', 800)">800ü•ï</button>
                    </div>

                    <div class="item-row">
                        <div style="font-size:2rem;">üõ°Ô∏è</div>
                        <div>
                            <strong>Seguro Anti-Quiebra</strong><br>
                            <span style="font-size:0.8rem; color:#64748b;">Te salva si llegas a 0 (1 uso)</span>
                        </div>
                        <button class="btn buy-btn" onclick="shop.buy('insurance', 1000)">1000ü•ï</button>
                    </div>

                    <div class="item-row win">
                        <div style="font-size:2rem;">üìú</div>
                        <div>
                            <strong>Contrato de Mambo</strong><br>
                            <span style="font-size:0.8rem; color:#be185d; font-weight:bold;">¬°LIBERTAD!
                                (Victoria)</span>
                        </div>
                        <button class="btn buy-btn" onclick="shop.payDebt()" id="btn-pay-debt">50000ü•ï</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- JUEGO: CARROT FLIP -->
        <div id="view-game-flip" class="hidden">
            <div class="game-area">
                <div class="flex justify-between items-center mb-2">
                    <button class="btn" style="background:#e2e8f0; font-size:0.8rem; padding:4px 8px;"
                        onclick="game.quit('flip')">Rendirse</button>
                    <div style="font-weight:bold; color:var(--green-dark);">Bote: <span id="flip-pot">0</span>ü•ï</div>
                </div>

                <div id="flip-buff-indicator" class="active-buff hidden">‚õëÔ∏è</div>

                <!-- El tablero Voltorb Flip cl√°sico -->
                <div class="flip-grid" id="flip-board"></div>

                <div class="flex justify-center gap-2" style="margin-top:1rem;">
                    <button class="btn" id="btn-memo" onclick="flipGame.toggleMemo()"
                        style="background:#f1f5f9; padding:8px;">‚úèÔ∏è Apuntes</button>
                    <button class="btn" id="btn-cashout" onclick="flipGame.cashOut()"
                        style="background:var(--pink-primary); color:white; padding:8px 20px;">Cobrar</button>
                </div>
                <p id="flip-msg" style="text-align:center; font-size:0.8rem; margin-top:0.5rem; color:#be185d;">
                    Encuentra 2x y 3x. ¬°Evita las nubes!</p>
            </div>
        </div>

        <!-- JUEGO: MEMORY -->
        <div id="view-game-memory" class="hidden">
            <div class="game-area">
                <div class="flex justify-between items-center mb-2">
                    <button class="btn" style="background:#e2e8f0; font-size:0.8rem; padding:4px 8px;"
                        onclick="game.quit('memory')">Salir</button>
                    <div style="font-weight:bold;">Intentos Restantes: <span id="mem-moves">0</span></div>
                </div>
                <div class="memory-board" id="memory-board"></div>
            </div>
        </div>

        <!-- JUEGO: ROULETTE -->
        <div id="view-game-roulette" class="hidden">
            <div class="game-area" style="text-align:center;">
                <div class="roulette-container">
                    <!-- Imagen de la chica de la Ruleta (Placeholder) -->
                    <img src="assets/img/mamboRuletaSF.png" class="roulette-girl-img" alt="Croupier">

                    <div>
                        <div
                            style="width:200px; height:200px; background:var(--green-dark); border-radius:50%; margin:0 auto 1rem; position:relative; display:flex; align-items:center; justify-content:center; border:8px solid white; box-shadow:0 0 0 4px var(--green-primary);">
                            <div id="wheel-spinner"
                                style="position:absolute; inset:0; border:4px dashed rgba(255,255,255,0.5); border-radius:50%;">
                            </div>
                            <div id="wheel-res"
                                style="background:white; width:60px; height:60px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:900; z-index:10;">
                                G1</div>
                        </div>
                    </div>
                </div>

                <p style="font-size:0.9rem;">Apuesta Total: <span id="roulette-bet-display">0</span></p>
                <div class="flex gap-2 justify-center mb-4">
                    <button class="btn" onclick="rouletteGame.pick('red')"
                        style="background:#ef4444; color:white; padding:10px 20px;">ROJO (x2)</button>
                    <button class="btn" onclick="rouletteGame.pick('black')"
                        style="background:#1e293b; color:white; padding:10px 20px;">NEGRO (x2)</button>
                    <button class="btn" onclick="rouletteGame.pick('green')"
                        style="background:#22c55e; color:white; padding:10px 20px;">VERDE (x14)</button>
                </div>
                <button class="btn" onclick="app.showMenu()"
                    style="background:#e2e8f0; font-size:0.8rem;">Volver</button>
            </div>
        </div>

        <!-- MENSAJES FLOTANTES -->
        <div id="result-overlay" class="hidden result-modal">
            <h2 id="result-title">TITULO</h2>
            <p id="result-msg">Mensaje</p>
            <button class="btn" onclick="document.getElementById('result-overlay').classList.add('hidden')"
                style="background:var(--slate-800); color:white; margin-top:1rem;">Cerrar</button>
        </div>

        <!-- STORY OVERLAY -->
        <div id="story-overlay">
            <div class="story-box">
                <!-- Imagen din√°mica -->
                <img src="" id="story-sprite" class="character-sprite" alt="Mambo">
                <div class="dialogue-box">
                    <div class="speaker-name">Mambo</div>
                    <p id="story-text" style="margin:0; min-height:3em; line-height:1.5;">...</p>
                    <div style="text-align:right; margin-top:1rem;">
                        <button class="btn" onclick="story.next()"
                            style="background:var(--pink-primary); color:white; padding:0.5rem 1.5rem;">Continuar
                            ‚ñº</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MAMBO CORNER (Asistente) -->
        <div id="host-corner" class="hidden">
            <div class="host-bubble" id="host-bubble">¬°T√∫ puedes!</div>
            <img src="assets/img/mamboIdleSF.png" class="host-img-small" alt="Chibi" onclick="host.randomQuote()">
        </div>

    </div>

    <script>
        /* --- GAME STATE --- */
        const app = {
            carrots: 100,
            debt: 50000,
            paid: 0,
            inventory: { helmet: 0, glasses: 0, insurance: 0 },

            init: function () {
                this.updateUI();
                story.play('intro');
            },

            updateUI: function () {
                document.getElementById('ui-carrots').textContent = this.carrots;
                document.getElementById('ui-debt').textContent = this.debt;
                document.getElementById('ui-paid').textContent = this.paid;
                const pct = Math.min(100, (this.paid / this.debt) * 100);
                document.getElementById('ui-progress').style.width = pct + '%';
            },

            showMenu: function () {
                hideAllViews();
                document.getElementById('view-menu').classList.remove('hidden');
                host.showCorner(); // Mambo vuelve
            },

            showShop: function () {
                hideAllViews();
                document.getElementById('view-shop').classList.remove('hidden');
                host.hideCorner();
                this.updateShopUI();
            },

            updateShopUI: function () {
                document.getElementById('btn-pay-debt').textContent = (this.debt - this.paid) + "ü•ï";
            },

            gameOver: function () {
                if (this.inventory.insurance > 0) {
                    this.inventory.insurance--;
                    this.carrots = 100;
                    alert("¬°El seguro te salv√≥! Recuperas 100 zanahorias.");
                    this.updateUI();
                    return;
                }
                story.play('gameover');
            },

            resetGame: function () {
                this.carrots = 100;
                this.debt = Math.floor(this.debt * 1.1); // Inter√©s por fallar
                this.paid = 0;
                this.updateUI();
                this.showMenu();
            },

            showAlert: function (title, msg) {
                document.getElementById('result-title').textContent = title;
                document.getElementById('result-msg').textContent = msg;
                document.getElementById('result-overlay').classList.remove('hidden');
            }
        };

        function hideAllViews() {
            document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
        }

        /* --- MAMBO HOST LOGIC --- */
        const host = {
            quotes: [
                "¬°Recuerda que los 1 no quitan puntos!",
                "Si tienes dudas, ¬°mejor ret√≠rate con lo ganado!",
                "¬°El rojo suele dar suerte hoy!",
                "¬°Vamos a pagar esa deuda!",
                "¬øUn descanso? ¬°Jam√°s!",
                "¬°Cuidado con las nubes de lluvia!"
            ],
            showCorner: function () {
                document.getElementById('host-corner').classList.remove('hidden');
            },
            hideCorner: function () {
                document.getElementById('host-corner').classList.add('hidden');
            },
            randomQuote: function () {
                const idx = Math.floor(Math.random() * this.quotes.length);
                const bubble = document.getElementById('host-bubble');
                bubble.textContent = this.quotes[idx];
                bubble.classList.add('show');
                setTimeout(() => bubble.classList.remove('show'), 3000);
            }
        };

        /* --- DEFINICI√ìN DE IM√ÅGENES DE MAMBO --- */
        const mamboSprites = {
            normal: "assets/img/mamboIdleSF.png",
            sad: "assets/img/mambosadSF.png",
            happy: "assets/img/WinningMamboSF.png",
            shock: "assets/img/DizzyMamboSF.png"
        };

        /* --- STORY ENGINE --- */
        const story = {
            queue: [],
            step: 0,

            scenes: {
                intro: [
                    { text: "¬°Entrenador! (Snif) Met√≠ la pata horrible...", emotion: "sad" },
                    { text: "Entr√© pensando que era un buffet‚Ä¶ y pues‚Ä¶ com√≠ como si fuera la √∫ltima cena.", emotion: "sad" },
                    { text: "Resulta que era un casino clandestino y ahora les debo 50,000 zanahorias. ¬°Cincuenta mil!", emotion: "shock" },
                    { text: "Si no pago antes de la carrera final‚Ä¶ me van a mandar a trabajar como poni de carga.", emotion: "sad" },
                    { text: "¬°Por favor! Ay√∫dame a recuperar las zanahorias en los juegos. Yo te ir√© guiando.", emotion: "normal" }
                ],
                gameover: [
                    { text: "¬°No queda nada! (Llorando)", emotion: "sad" },
                    { text: "Supongo que este es mi fin.", emotion: "sad" },
                    { text: "... Espera, nos dan otra oportunidad.", emotion: "normal" },
                    { text: "¬°Pero aument√≥ la deuda! ¬°Cuidado!", emotion: "shock" }
                ],
                win: [
                    { text: "¬°LO LOGRAMOS! (Saltando)", emotion: "happy" },
                    { text: "¬°Gracias entrenador! ¬°Eres el mejor!", emotion: "happy" }
                ]
            },

            play: function (sceneKey) {
                this.queue = this.scenes[sceneKey];
                this.step = 0;
                if (!this.queue) return;
                document.getElementById('story-overlay').classList.add('visible');
                host.hideCorner();
                this.render();
            },

            render: function () {
                const current = this.queue[this.step];

                // Texto
                document.getElementById('story-text').textContent = current.text;

                // Imagen
                const imgUrl = mamboSprites[current.emotion] || mamboSprites['normal'];
                document.getElementById('story-sprite').src = imgUrl;

                // Clases para animaciones CSS
                document.getElementById('story-sprite').className = 'character-sprite sprite-' + current.emotion;
            },

            next: function () {
                this.step++;
                if (this.step >= this.queue.length) {
                    document.getElementById('story-overlay').classList.remove('visible');
                    if (this.queue === this.scenes.gameover) app.resetGame();
                    else app.showMenu();
                } else {
                    this.render();
                }
            }
        };

        /* --- SHOP LOGIC --- */
        const shop = {
            buy: function (item, cost) {
                if (app.carrots >= cost) {
                    app.carrots -= cost;
                    if (item === 'helmet' || item === 'glasses' || item === 'insurance') {
                        app.inventory[item] = (app.inventory[item] || 0) + (item === 'helmet' ? 5 : 1);
                        alert(`¬°Comprado! Tienes ${app.inventory[item]} usos.`);
                    }
                    app.updateUI();
                } else {
                    alert("No tienes suficientes zanahorias...");
                }
            },
            payDebt: function () {
                const remaining = app.debt - app.paid;
                if (app.carrots >= remaining) {
                    app.carrots -= remaining;
                    app.paid = app.debt;
                    app.updateUI();
                    story.play('win');
                } else {
                    if (app.carrots > 0) {
                        const pay = app.carrots;
                        app.carrots = 0;
                        app.paid += pay;
                        app.updateUI();
                        alert(`Abonaste ${pay} zanahorias. Faltan ${app.debt - app.paid}.`);
                        if (app.carrots === 0 && app.paid < app.debt) app.gameOver();
                    } else {
                        alert("¬°Est√°s en bancarrota!");
                    }
                }
            }
        };

        /* --- GENERAL GAME MANAGER --- */
        const game = {
            currentGame: null,
            difficulty: 1, // 1 (Novice), 2 (Runner), 5 (G1)
            betCost: 0,

            openDifficulty: function (gameType) {
                this.currentGame = gameType;
                hideAllViews();
                host.hideCorner(); // Hide Mambo while playing
                document.getElementById('view-difficulty').classList.remove('hidden');
                const container = document.getElementById('diff-options');
                container.innerHTML = '';

                const options = [
                    { label: 'Novato', cost: 10, mult: 1, desc: 'Riesgo bajo. Pocas bombas.' },
                    { label: 'Corredor', cost: 50, mult: 2, desc: 'Riesgo medio. M√°s multiplicadores.' },
                    { label: 'G1 Derby', cost: 100, mult: 5, desc: 'RIESGO ALTO. Tablero complejo.' }
                ];

                options.forEach((opt) => {
                    const div = document.createElement('div');
                    div.className = 'bet-option';
                    div.innerHTML = `${opt.label}<br><span style="font-size:0.8rem">${opt.cost}ü•ï</span>`;
                    div.onclick = () => this.selectBet(opt, div);
                    if (app.carrots < opt.cost) { div.style.opacity = '0.5'; div.onclick = null; }
                    container.appendChild(div);
                });

                document.getElementById('diff-desc').textContent = "Selecciona una apuesta...";
                document.getElementById('btn-start-game').disabled = true;
            },

            selectBet: function (opt, el) {
                document.querySelectorAll('.bet-option').forEach(e => e.classList.remove('selected'));
                el.classList.add('selected');
                document.getElementById('diff-desc').textContent = opt.desc;
                this.betCost = opt.cost;
                this.difficulty = opt.mult;
                document.getElementById('btn-start-game').disabled = false;
            },

            confirmStart: function () {
                app.carrots -= this.betCost;
                app.updateUI();
                hideAllViews();
                if (this.currentGame === 'flip') flipGame.init();
                if (this.currentGame === 'memory') memoryGame.init();
                if (this.currentGame === 'roulette') rouletteGame.init();
            },

            quit: function (from) {
                app.showMenu();
            },

            finishGame: function (earnings) {
                app.carrots += earnings;
                app.updateUI();
                if (app.carrots <= 0) {
                    app.gameOver();
                } else {
                    app.showMenu();
                }
            }
        };

        /* --- GAME 1: FLIP (Auto Win Logic) --- */
        const flipGame = {
            grid: [],
            active: false,
            memo: false,
            pot: 0,
            helmetActive: false,

            init: function () {
                document.getElementById('view-game-flip').classList.remove('hidden');
                this.active = true;
                this.memo = false;
                this.pot = game.betCost;
                this.grid = [];

                this.helmetActive = app.inventory.helmet > 0;
                if (this.helmetActive) {
                    app.inventory.helmet--;
                    document.getElementById('flip-buff-indicator').classList.remove('hidden');
                } else {
                    document.getElementById('flip-buff-indicator').classList.add('hidden');
                }

                let bombCount = 6;
                let multiTarget = 5;

                if (game.difficulty === 2) { bombCount = 8; multiTarget = 8; }
                if (game.difficulty === 5) { bombCount = 10; multiTarget = 12; }

                for (let i = 0; i < 25; i++) this.grid.push({ val: 1, flip: false, memos: [0, 0, 0, 0] });

                let bombsPlaced = 0;
                while (bombsPlaced < bombCount) {
                    let idx = Math.floor(Math.random() * 25);
                    if (this.grid[idx].val !== 0) { this.grid[idx].val = 0; bombsPlaced++; }
                }

                let mPlaced = 0;
                while (mPlaced < multiTarget) {
                    let idx = Math.floor(Math.random() * 25);
                    if (this.grid[idx].val === 1) {
                        let isThree = game.difficulty === 5 ? (Math.random() > 0.6) : (Math.random() > 0.8);
                        this.grid[idx].val = isThree ? 3 : 2;
                        mPlaced++;
                    }
                }

                if (app.inventory.glasses > 0) {
                    app.inventory.glasses--;
                    let revealed = 0;
                    this.grid.forEach(c => { if (c.val === 0 && revealed < 3) { c.memos[0] = 1; revealed++; } });
                    alert("¬°Binoculares activos! Bombas marcadas.");
                }

                this.updateBoard();
            },

            calculateSums: function () {
                const rows = [], cols = [];
                for (let i = 0; i < 5; i++) {
                    let rSum = 0, rBomb = 0, cSum = 0, cBomb = 0;
                    for (let j = 0; j < 5; j++) {
                        let rVal = this.grid[i * 5 + j].val;
                        rSum += rVal; if (rVal === 0) rBomb++;
                        let cVal = this.grid[j * 5 + i].val;
                        cSum += cVal; if (cVal === 0) cBomb++;
                    }
                    rows.push({ sum: rSum, bomb: rBomb });
                    cols.push({ sum: cSum, bomb: cBomb });
                }
                return { rows, cols };
            },

            updateBoard: function () {
                const div = document.getElementById('flip-board');
                div.innerHTML = '';
                document.getElementById('flip-pot').textContent = this.pot;
                const sums = this.calculateSums();

                for (let i = 0; i < 25; i++) {
                    const c = this.grid[i];
                    const el = document.createElement('div');
                    el.className = `flip-cell ${c.flip ? 'flipped' : ''}`;

                    if (c.flip) {
                        if (c.val === 0) el.textContent = 'üåßÔ∏è';
                        else if (c.val > 1) { el.textContent = c.val; el.style.color = c.val === 3 ? '#b45309' : '#15803d'; }
                        else el.textContent = '1';
                    } else {
                        if (c.memos[0]) el.innerHTML += `<div class="memo-marker m-0">üåßÔ∏è</div>`;
                        if (c.memos[1]) el.innerHTML += `<div class="memo-marker m-1">1</div>`;
                        if (c.memos[2]) el.innerHTML += `<div class="memo-marker m-2">2</div>`;
                        if (c.memos[3]) el.innerHTML += `<div class="memo-marker m-3">3</div>`;
                    }
                    el.onclick = (e) => this.click(i, e);
                    div.appendChild(el);

                    if ((i + 1) % 5 === 0) {
                        const rData = sums.rows[Math.floor(i / 5)];
                        const info = document.createElement('div');
                        info.className = 'info-cell';
                        info.innerHTML = `<span>${rData.sum}</span><span style="border-top:1px solid #fdba74; width:80%"></span><span>üåßÔ∏è${rData.bomb}</span>`;
                        div.appendChild(info);
                    }
                }
                for (let c = 0; c < 5; c++) {
                    const cData = sums.cols[c];
                    const info = document.createElement('div');
                    info.className = 'info-cell';
                    info.innerHTML = `<span>${cData.sum}</span><span style="border-top:1px solid #fdba74; width:80%"></span><span>üåßÔ∏è${cData.bomb}</span>`;
                    div.appendChild(info);
                }
            },

            click: function (i, e) {
                if (!this.active || this.grid[i].flip) return;

                if (this.memo) {
                    const rect = e.target.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    let mIdx = 0;
                    if (y < rect.height / 2) mIdx = (x < rect.width / 2) ? 0 : 1;
                    else mIdx = (x < rect.width / 2) ? 2 : 3;
                    this.grid[i].memos[mIdx] = !this.grid[i].memos[mIdx];
                    this.updateBoard();
                    return;
                }

                this.grid[i].flip = true;
                if (this.grid[i].val === 0) {
                    this.active = false;
                    this.updateBoard();
                    setTimeout(() => {
                        app.showAlert("¬°TORMENTA!", "Has perdido todo el progreso de esta ronda.");
                        game.finishGame(0);
                    }, 500);
                } else {
                    if (this.grid[i].val > 1) {
                        let mult = this.grid[i].val;
                        if (this.helmetActive) mult *= 2;
                        this.pot = Math.floor(this.pot * mult);
                    }
                    this.updateBoard();

                    // --- AUTO WIN CHECK ---
                    const remainingMultis = this.grid.filter(c => !c.flip && c.val > 1).length;
                    if (remainingMultis === 0) {
                        this.active = false;
                        setTimeout(() => {
                            app.showAlert("¬°LIMPIO!", `¬°Tablero completado! Cobrando ${this.pot} zanahorias autom√°ticamente.`);
                            game.finishGame(this.pot);
                        }, 500);
                    }
                }
            },

            toggleMemo: function () {
                this.memo = !this.memo;
                document.getElementById('btn-memo').style.background = this.memo ? '#facc15' : '#f1f5f9';
            },

            cashOut: function () {
                if (!this.active) return;
                game.finishGame(this.pot);
            }
        };

        /* --- GAME 2: MEMORY --- */
        const memoryGame = {
            active: false,
            cards: [],
            flipped: [],
            matches: 0,

            init: function () {
                document.getElementById('view-game-memory').classList.remove('hidden');
                this.active = true;
                this.flipped = [];
                this.matches = 0;

                let pairCount = 6;
                let attempts = 12;

                if (game.difficulty === 2) { pairCount = 8; attempts = 12; }
                if (game.difficulty === 5) { pairCount = 10; attempts = 10; }

                document.getElementById('mem-moves').textContent = attempts;
                this.attemptsLeft = attempts;

                const types = ['ü•ï', '‚ö°', 'üíé', 'üíä', 'üåô', 'üî•', '‚ù§Ô∏è', '‚≠ê', 'üçÄ', 'üçé'];
                let selectedTypes = types.slice(0, pairCount);
                let deck = [...selectedTypes, ...selectedTypes].sort(() => Math.random() - 0.5);

                const board = document.getElementById('memory-board');
                board.innerHTML = '';
                board.style.gridTemplateColumns = pairCount > 8 ? 'repeat(5, 1fr)' : 'repeat(4, 1fr)';

                this.cards = deck.map((val, i) => {
                    const el = document.createElement('div');
                    el.className = 'flip-cell';
                    el.style.background = '#60a5fa';
                    el.onclick = () => this.click(i);
                    board.appendChild(el);
                    return { val, el, solved: false };
                });
            },

            click: function (i) {
                if (!this.active || this.cards[i].solved || this.flipped.includes(i) || this.flipped.length >= 2) return;

                const c = this.cards[i];
                c.el.textContent = c.val;
                c.el.style.background = 'white';
                this.flipped.push(i);

                if (this.flipped.length === 2) {
                    this.attemptsLeft--;
                    document.getElementById('mem-moves').textContent = this.attemptsLeft;

                    const [a, b] = this.flipped;
                    if (this.cards[a].val === this.cards[b].val) {
                        this.cards[a].solved = true;
                        this.cards[b].solved = true;
                        this.flipped = [];
                        this.matches++;

                        if (this.matches === this.cards.length / 2) {
                            const win = game.betCost * (3 + game.difficulty);
                            setTimeout(() => {
                                app.showAlert("¬°MEMORIA PERFECTA!", `Ganaste ${win} zanahorias.`);
                                game.finishGame(win);
                            }, 500);
                        }
                    } else {
                        if (this.attemptsLeft <= 0) {
                            setTimeout(() => {
                                app.showAlert("SIN INTENTOS", "Te quedaste sin energ√≠a...");
                                game.finishGame(0);
                            }, 500);
                            return;
                        }
                        setTimeout(() => {
                            this.cards[a].el.textContent = ''; this.cards[a].el.style.background = '#60a5fa';
                            this.cards[b].el.textContent = ''; this.cards[b].el.style.background = '#60a5fa';
                            this.flipped = [];
                        }, 800);
                    }
                }
            }
        };

        /* --- GAME 3: ROULETTE --- */
        const rouletteGame = {
            init: function () {
                document.getElementById('view-game-roulette').classList.remove('hidden');
                document.getElementById('roulette-bet-display').textContent = game.betCost;
            },
            pick: function (choice) {
                const spinEl = document.getElementById('wheel-spinner');
                spinEl.classList.add('animate-spin');
                spinEl.style.transform = `rotate(${Math.random() * 1000}deg)`;
                spinEl.style.transition = "transform 2s";

                setTimeout(() => {
                    spinEl.classList.remove('animate-spin');
                    const res = Math.random() > 0.1 ? (Math.random() > 0.5 ? 'red' : 'black') : 'green';
                    document.getElementById('wheel-res').textContent = res === 'red' ? 'üî¥' : (res === 'black' ? '‚ö´' : 'üü¢');

                    let win = 0;
                    let title = "PERDISTE";
                    let msg = `Sali√≥ ${res === 'red' ? 'Rojo' : (res === 'black' ? 'Negro' : 'Verde')}.`;

                    if (choice === res) {
                        win = game.betCost * (res === 'green' ? 14 : 2);
                        title = "¬°GANASTE!";
                        msg = `¬°La suerte est√° contigo! +${win} zanahorias.`;
                    }

                    app.showAlert(title, msg);
                    game.finishGame(win);
                }, 2000);
            }
        };

        // START
        app.init();
    </script>
</body>

</html>